<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>1.0</title>
    <style>
        body {
            margin: 0;
            padding: 0;
            overflow: hidden;
            background-color: #f5f5f5;
            height: 100vh;
            width: 100vw;
            font-family: "Microsoft YaHei", "微软雅黑", sans-serif;
            background-image: radial-gradient(circle at 10% 20%, rgba(255,221,225,0.3) 0%, rgba(204,235,255,0.3) 90%);
            transition: background 1s ease;
        }

        /* 气泡样式 */
        .warm-tip-window {
            position: absolute;
            width: 250px;
            height: 60px;
            display: flex;
            align-items: center;
            justify-content: center;
            border: 2px solid transparent;
            border-radius: 12px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.15);
            font-size: 16px;
            font-weight: bold;
            color: #333;
            z-index: 1000;
            user-select: none;
            cursor: move;
            animation: popIn 0.5s cubic-bezier(0.34, 1.56, 0.64, 1);
            transition: all 0.3s ease;
            backdrop-filter: blur(5px);
            padding: 0 15px;
            text-align: center;
            word-break: break-all;
        }

        .fixed-tip-window {
            position: fixed;
            cursor: default;
            z-index: 2500;
            animation: float 8s ease-in-out infinite;
            width: 280px;
            height: 70px;
        }

        .warm-tip-window::before {
            content: '';
            position: absolute;
            top: -2px;
            left: -2px;
            right: -2px;
            bottom: -2px;
            border-radius: 12px;
            background: linear-gradient(45deg, var(--border-color1), var(--border-color2));
            z-index: -1;
            opacity: 0.7;
            transition: opacity 0.3s ease;
        }

        .warm-tip-window:hover {
            transform: scale(1.1) rotate(1deg);
            z-index: 1001;
            box-shadow: 0 8px 25px rgba(0,0,0,0.25);
            border-color: rgba(255,255,255,0.8);
        }

        .fixed-tip-window:hover {
            transform: scale(1.15) rotate(1deg);
            z-index: 3000;
        }

        .warm-tip-window:hover::before {
            opacity: 1;
        }

        .warm-tip-window.active {
            width: 320px;
            height: 80px;
            font-size: 20px;
            transform: scale(1.15) rotate(2deg);
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            z-index: 2000;
            animation: bounce 0.5s ease;
        }

        .fixed-tip-window.active {
            width: 350px;
            height: 90px;
            font-size: 22px;
        }

        .text-flicker {
            animation: flicker 3s ease-in-out infinite;
        }

        /* 粒子效果 */
        .particle {
            position: absolute;
            border-radius: 50%;
            pointer-events: none;
            z-index: 999;
        }

        /* 动画定义 */
        @keyframes popIn {
            0% { transform: scale(0) rotate(-10deg); opacity: 0; }
            70% { transform: scale(1.1) rotate(5deg); opacity: 0.9; }
            100% { transform: scale(1) rotate(0); opacity: 1; }
        }

        @keyframes float {
            0% { transform: translateY(0) rotate(0deg); }
            50% { transform: translateY(-10px) rotate(2deg); }
            100% { transform: translateY(0) rotate(0deg); }
        }

        @keyframes pulse {
            0% { box-shadow: 0 4px 15px rgba(0,0,0,0.15); }
            50% { box-shadow: 0 6px 20px rgba(0,0,0,0.25); }
            100% { box-shadow: 0 4px 15px rgba(0,0,0,0.15); }
        }

        @keyframes flicker {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.8; }
            70% { opacity: 1.1; }
        }

        @keyframes bounce {
            0%, 100% { transform: scale(1.15) rotate(2deg); }
            50% { transform: scale(1.2) rotate(-1deg); }
        }

        @keyframes drift {
            0% { transform: translate(0, 0) rotate(0deg); }
            25% { transform: translate(10px, -5px) rotate(1deg); }
            50% { transform: translate(0, 10px) rotate(0deg); }
            75% { transform: translate(-10px, -5px) rotate(-1deg); }
            100% { transform: translate(0, 0) rotate(0deg); }
        }

        .text-gradient {
            background-clip: text;
            -webkit-background-clip: text;
            color: transparent;
            background-image: linear-gradient(45deg, #333, #666);
        }

        /* 控制面板 */
        .control-panel {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(255,255,255,0.8);
            padding: 8px 20px;
            border-radius: 20px;
            font-size: 14px;
            color: #666;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            z-index: 3000;
            backdrop-filter: blur(3px);
            display: flex;
            gap: 20px;
            align-items: center;
        }

        .counter {
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .btn {
            background: linear-gradient(45deg, #8ec5fc, #e0c3fc);
            border: none;
            padding: 6px 12px;
            border-radius: 15px;
            color: #fff;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.2s ease;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }

        .btn:hover {
            transform: scale(1.05);
            box-shadow: 0 3px 8px rgba(0,0,0,0.15);
        }

        .btn.clear {
            background: linear-gradient(45deg, #ff9aa2, #ffb7b2);
        }

        /* 右键菜单 */
        .context-menu {
            position: absolute;
            width: 120px;
            background: rgba(255,255,255,0.95);
            border-radius: 8px;
            box-shadow: 0 3px 10px rgba(0,0,0,0.2);
            z-index: 5000;
            display: none;
            backdrop-filter: blur(5px);
        }

        .context-menu-item {
            padding: 8px 12px;
            cursor: pointer;
            transition: background 0.2s ease;
            font-size: 14px;
            color: #666;
        }

        .context-menu-item:hover {
            background: rgba(230,230,255,0.7);
        }

        .context-menu-item:first-child {
            border-radius: 8px 8px 0 0;
        }

        .context-menu-item:last-child {
            border-radius: 0 0 8px 8px;
        }

        /* 表白界面样式 - 重新设计 */
        .confession-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background: linear-gradient(135deg, 
                #f093fb 0%, 
                #f5576c 25%, 
                #4facfe 50%, 
                #00f2fe 75%, 
                #a8edea 100%);
            background-size: 400% 400%;
            animation: gradientShift 20s ease infinite;
            z-index: 9999;
            display: none;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            overflow: hidden;
            position: relative;
        }

        /* 背景渐变动画 - 更柔和的过渡 */
        @keyframes gradientShift {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }

        /* 光晕背景 */
        .confession-container::before {
            content: '';
            position: absolute;
            width: 80vw;
            height: 80vw;
            border-radius: 50%;
            background: radial-gradient(circle, rgba(255,255,255,0.2) 0%, rgba(255,255,255,0) 70%);
            filter: blur(50px);
            animation: glowPulse 8s ease-in-out infinite;
            z-index: 1;
        }

        @keyframes glowPulse {
            0%, 100% { transform: scale(1) translate(0, 0); opacity: 0.7; }
            50% { transform: scale(1.1) translate(-10px, -10px); opacity: 1; }
        }

        /* 装饰性网格背景 */
        .confession-container::after {
            content: '';
            position: absolute;
            width: 100%;
            height: 100%;
            background-image: 
                linear-gradient(rgba(255,255,255,0.1) 1px, transparent 1px),
                linear-gradient(90deg, rgba(255,255,255,0.1) 1px, transparent 1px);
            background-size: 50px 50px;
            z-index: 1;
            animation: gridMove 20s linear infinite;
        }

        @keyframes gridMove {
            0% { background-position: 0 0; }
            100% { background-position: 100px 100px; }
        }

        /* 表白文字样式 - 重新设计 */
        .confession-text {
            font-size: clamp(4rem, 10vw, 8rem);
            font-weight: 800;
            background: linear-gradient(120deg, 
                #ffffff 0%, 
                #f8f9fa 25%, 
                #e9ecef 50%, 
                #dee2e6 75%, 
                #ffffff 100%);
            background-clip: text;
            -webkit-background-clip: text;
            color: transparent;
            position: relative;
            z-index: 2;
            text-shadow: 
                0 2px 10px rgba(0,0,0,0.1),
                0 4px 20px rgba(0,0,0,0.05);
            animation: 
                textFloat 6s ease-in-out infinite,
                textGlow 4s ease-in-out infinite alternate;
            margin-bottom: 2rem;
            letter-spacing: 0.1em;
            padding: 0 2rem;
            text-align: center;
        }

        @keyframes textGlow {
            from { 
                text-shadow: 
                    0 2px 10px rgba(0,0,0,0.1),
                    0 4px 20px rgba(0,0,0,0.05),
                    0 0 20px rgba(255,255,255,0.3); 
            }
            to { 
                text-shadow: 
                    0 2px 10px rgba(0,0,0,0.15),
                    0 4px 20px rgba(0,0,0,0.1),
                    0 0 40px rgba(255,255,255,0.6),
                    0 0 80px rgba(255,255,255,0.3); 
            }
        }

        @keyframes textFloat {
            0% { transform: translateY(0) rotate(0deg); }
            25% { transform: translateY(-10px) rotate(0.5deg); }
            50% { transform: translateY(0) rotate(0deg); }
            75% { transform: translateY(10px) rotate(-0.5deg); }
            100% { transform: translateY(0) rotate(0deg); }
        }

        /* 副标题 - 重新设计 */
        .confession-subtext {
            font-size: clamp(1.5rem, 3vw, 2.5rem);
            color: rgba(255, 255, 255, 0.9);
            text-shadow: 0 2px 10px rgba(0,0,0,0.1);
            position: relative;
            z-index: 2;
            animation: subtextFade 6s ease-in-out infinite alternate;
            letter-spacing: 0.2em;
            text-align: center;
            padding: 0 2rem;
            background: rgba(255,255,255,0.1);
            backdrop-filter: blur(10px);
            padding: 1rem 2rem;
            border-radius: 50px;
            border: 1px solid rgba(255,255,255,0.2);
        }

        @keyframes subtextFade {
            from { 
                opacity: 0.8; 
                transform: scale(1);
                box-shadow: 0 4px 20px rgba(0,0,0,0.1);
            }
            to { 
                opacity: 1; 
                transform: scale(1.05);
                box-shadow: 0 8px 30px rgba(0,0,0,0.15);
            }
        }

        /* 装饰性光点 */
        .decorative-dot {
            position: absolute;
            width: 2px;
            height: 2px;
            background: white;
            border-radius: 50%;
            opacity: 0;
            animation: dotTwinkle 4s ease-in-out infinite;
            z-index: 1;
        }

        @keyframes dotTwinkle {
            0%, 100% { opacity: 0; transform: scale(1); }
            50% { opacity: 1; transform: scale(1.5); }
        }
    </style>
</head>
<body>
    <div class="control-panel">
        <div class="counter">咕噜泡泡:<span id="tipCount">0</span> 个</div>
        <button class="btn add" id="addBtn">新增气泡</button>
        <button class="btn clear" id="clearBtn">清空所有</button>
    </div>

    <!-- 右键菜单 -->
    <div class="context-menu" id="contextMenu">
        <div class="context-menu-item" data-action="copy">复制文字</div>
        <div class="context-menu-item" data-action="top">置顶窗口</div>
        <div class="context-menu-item" data-action="random">随机位置</div>
        <div class="context-menu-item" data-action="close">关闭气泡</div>
    </div>

    <!-- 第二界面容器 -->
    <div class="confession-container" id="confessionContainer">
        <div class="confession-text">当ててみて</div>
        <div class="confession-subtext">ちょっとあなたが好きなのかな☺️</div>
    </div>

    <script>
        // 核心变量
        const wordLib = {
            prefix: ['悄悄说', '记得', '一定要', '愿你', '希望你', '别忘了', '偷偷告诉你', '其实', '此刻', '忽然觉得'],
            action: ['好好吃饭', '认真休息', '保持快乐', '享受时光', '善待自己', '坚持热爱', '拥抱生活', '放慢脚步', '积攒美好', '传递温暖'],
            emotion: ['甜甜的', '暖暖的', '元气满满的', '温柔的', '坚定的', '轻松的', '治愈的', '安心的', '雀跃的', '从容的'],
            result: ['万事顺意', '好运常在', '笑容常在', '被爱包围', '收获惊喜', '平安喜乐', '心想事成', '日日顺心', '烦恼消散', '幸福感满溢'],
            scene: ['天凉添衣', '天热多喝水', '阴雨天带伞', '熬夜伤身体', '空腹别喝咖啡', '久坐记得拉伸', '累了就歇会儿', '睡前别玩手机'],
            encourage: ['你真的很棒', '再坚持一下', '你比想象中厉害', '不要轻易放弃', '你值得所有美好', '继续闪闪发光', '你的努力会有回报'],
            suffix: ['呀～', '哦～', '呢', '呀', '哦', '呀！', '哦！', '呢～']
        };

        const textTemplates = [
            '{prefix}，{action}{suffix}',
            '{emotion}{action}，{result}{suffix}',
            '{scene}，{emotion}过一天{suffix}',
            '{encourage}，{action}就好{suffix}',
            '{prefix}，{emotion}你最可爱{suffix}',
            '{action}，{result}呀～',
            '{prefix}，{scene}，别大意{suffix}',
            '{emotion}时光里，{result}{suffix}',
            '{encourage}，未来可期{suffix}',
            '{prefix}，{result}，因为有你{suffix}',
            '{action}，{emotion}幸福感{suffix}',
            '{scene}，{action}更健康{suffix}',
            '{prefix}，你值得{emotion}{result}{suffix}',
            '{encourage}，{emotion}坚持下去{suffix}',
            '{action}，让{emotion}日子常伴{suffix}',
            '{prefix}，{emotion}{action}，好运自来{suffix}'
        ];

        const bgColors = [
            'rgba(255, 221, 225, 0.85)', 'rgba(191, 239, 255, 0.85)', 'rgba(204, 255, 204, 0.85)',
            'rgba(230, 230, 255, 0.85)', 'rgba(255, 255, 204, 0.85)', 'rgba(255, 218, 225, 0.85)',
            'rgba(255, 230, 204, 0.85)', 'rgba(221, 255, 255, 0.85)', 'rgba(240, 230, 255, 0.85)',
            'rgba(255, 240, 245, 0.85)', 'rgba(240, 255, 240, 0.85)', 'rgba(255, 250, 240, 0.85)',
            'rgba(225, 242, 255, 0.85)', 'rgba(255, 236, 210, 0.85)', 'rgba(237, 246, 255, 0.85)'
        ];

        const borderColorPairs = [
            ['#ff9aa2', '#ffb7b2'], ['#8ec5fc', '#e0c3fc'], ['#a8edea', '#fed6e3'],
            ['#ffd1ff', '#fa8bff'], ['#f9f586', '#f8d886'], ['#caffbf', '#9bf6ff'],
            ['#ffadad', '#ffd6a5'], ['#fdffb6', '#caffc7'], ['#9bf6ff', '#bdb2ff']
        ];

        const particleColors = [
            'rgba(255, 154, 162, 0.7)', 'rgba(142, 197, 252, 0.7)', 'rgba(168, 237, 234, 0.7)',
            'rgba(255, 209, 255, 0.7)', 'rgba(249, 245, 134, 0.7)', 'rgba(202, 255, 191, 0.7)'
        ];

        // 关键控制变量
        let tipCount = 0;
        let clickCount = 0; // 记录新增气泡点击次数
        let hasClearedFirst = false; // 标记是否首次清空
        let confessionUnlocked = false; // 标记是否解锁表白界面（清空后才解锁）
        const tipCountElement = document.getElementById('tipCount');
        const contextMenu = document.getElementById('contextMenu');
        const confessionContainer = document.getElementById('confessionContainer');
        let currentWindow = null;
        let fixedTipWindow = null;

        // 生成随机文字
        function generateRandomText() {
            const template = textTemplates[Math.floor(Math.random() * textTemplates.length)];
            return template.replace(/{(\w+)}/g, (match, key) => {
                const words = wordLib[key];
                return words[Math.floor(Math.random() * words.length)];
            });
        }

        // 随机获取颜色对
        function getRandomColorPair() {
            const pair = borderColorPairs[Math.floor(Math.random() * borderColorPairs.length)];
            const bgColor = bgColors[Math.floor(Math.random() * bgColors.length)];
            return { bgColor, border1: pair[0], border2: pair[1] };
        }

        // 显示温馨提示窗口
        function showWarmTip() {
            const tipWindow = document.createElement('div');
            tipWindow.className = 'warm-tip-window text-gradient';
            
            const text = generateRandomText();
            const { bgColor, border1, border2 } = getRandomColorPair();
            
            tipWindow.innerText = text;
            tipWindow.style.backgroundColor = bgColor;
            tipWindow.style.setProperty('--border-color1', border1);
            tipWindow.style.setProperty('--border-color2', border2);

            const screenWidth = window.innerWidth;
            const screenHeight = window.innerHeight;
            const winWidth = 250;
            const winHeight = 60;

            const x = 20 + Math.random() * (screenWidth - winWidth - 40);
            const y = 20 + Math.random() * (screenHeight - winHeight - 40);

            tipWindow.style.left = x + 'px';
            tipWindow.style.top = y + 'px';

            const animType = Math.random();
            if (animType > 0.6) {
                tipWindow.style.animation = 'float 8s ease-in-out infinite';
            } else if (animType > 0.3) {
                tipWindow.style.animation = 'pulse 4s ease-in-out infinite';
            } else {
                tipWindow.style.animation = 'drift 12s ease-in-out infinite';
            }

            if (Math.random() < 0.2) {
                tipWindow.classList.add('text-flicker');
            }

            tipWindow.dataset.speedX = (Math.random() - 0.5) * 0.5;
            tipWindow.dataset.speedY = (Math.random() - 0.5) * 0.5;

            makeDraggable(tipWindow);

            // 左键点击：变色+粒子效果
            tipWindow.onclick = function(e) {
                e.stopPropagation();
                const { bgColor: newBg, border1: newBorder1, border2: newBorder2 } = getRandomColorPair();
                this.style.backgroundColor = newBg;
                this.style.setProperty('--border-color1', newBorder1);
                this.style.setProperty('--border-color2', newBorder2);
                createParticles(e.clientX, e.clientY);
            };

            // 双击放大/还原+刷新文字
            tipWindow.ondblclick = function(e) {
                e.stopPropagation();
                this.classList.toggle('active');
                
                if (this.classList.contains('active')) {
                    this.innerText = generateRandomText();
                } else {
                    this.innerText = generateRandomText();
                    const animType = Math.random();
                    if (animType > 0.6) {
                        this.style.animation = 'float 8s ease-in-out infinite';
                    } else if (animType > 0.3) {
                        this.style.animation = 'pulse 4s ease-in-out infinite';
                    } else {
                        this.style.animation = 'drift 12s ease-in-out infinite';
                    }
                }
            };

            // 右键菜单
            tipWindow.oncontextmenu = function(e) {
                e.preventDefault();
                currentWindow = this;
                
                contextMenu.style.display = 'block';
                contextMenu.style.left = e.clientX + 'px';
                contextMenu.style.top = e.clientY + 'px';
            };

            avoidOverlap(tipWindow);

            document.body.appendChild(tipWindow);
            tipCount++;
            updateTipCount();

            startAutoMove(tipWindow);
        }

        // 创建固定在右下角的气泡
        function createFixedTipWindow() {
            const tipWindow = document.createElement('div');
            tipWindow.className = 'warm-tip-window text-gradient fixed-tip-window';
            
            const customText = '睡觉要早，记性要好，吃饭要饱，心情要妙～';
            const colorPair = borderColorPairs[1];
            const bgColor = bgColors[3];
            
            tipWindow.innerText = customText;
            tipWindow.style.backgroundColor = bgColor;
            tipWindow.style.setProperty('--border-color1', colorPair[0]);
            tipWindow.style.setProperty('--border-color2', colorPair[1]);

            const screenWidth = window.innerWidth;
            const screenHeight = window.innerHeight;
            const winWidth = 280;
            const winHeight = 70;

            const x = screenWidth - winWidth - 20;
            const y = screenHeight - winHeight - 20;

            tipWindow.style.left = x + 'px';
            tipWindow.style.top = y + 'px';

            tipWindow.style.animation = 'float 6s ease-in-out infinite';
            tipWindow.classList.add('text-flicker');

            tipWindow.onclick = function(e) {
                e.stopPropagation();
                const { bgColor: newBg, border1: newBorder1, border2: newBorder2 } = getRandomColorPair();
                this.style.backgroundColor = newBg;
                this.style.setProperty('--border-color1', newBorder1);
                this.style.setProperty('--border-color2', newBorder2);
                createParticles(e.clientX, e.clientY);
            };

            tipWindow.ondblclick = function(e) {
                e.stopPropagation();
                this.classList.toggle('active');
            };

            tipWindow.oncontextmenu = function(e) {
                e.preventDefault();
                currentWindow = this;
                
                contextMenu.style.display = 'block';
                contextMenu.style.left = e.clientX + 'px';
                contextMenu.style.top = e.clientY + 'px';
                
                contextMenu.querySelectorAll('.context-menu-item').forEach(item => {
                    if (item.dataset.action === 'random' || item.dataset.action === 'close') {
                        item.style.display = 'none';
                    } else {
                        item.style.display = 'block';
                    }
                });
            };

            document.body.appendChild(tipWindow);
            fixedTipWindow = tipWindow;
        }

        // 拖拽功能
        function makeDraggable(element) {
            if (element.classList.contains('fixed-tip-window')) return;
            
            let pos1 = 0, pos2 = 0, pos3 = 0, pos4 = 0;

            element.onmousedown = dragStart;

            function dragStart(e) {
                e.preventDefault();
                pos3 = e.clientX;
                pos4 = e.clientY;

                element.style.zIndex = 2000;
                document.onmousemove = dragMove;
                document.onmouseup = dragEnd;
            }

            function dragMove(e) {
                e.preventDefault();
                pos1 = pos3 - e.clientX;
                pos2 = pos4 - e.clientY;
                pos3 = e.clientX;
                pos4 = e.clientY;

                const newLeft = element.offsetLeft - pos1;
                const newTop = element.offsetTop - pos2;
                const screenWidth = window.innerWidth;
                const screenHeight = window.innerHeight;
                const winWidth = element.offsetWidth;
                const winHeight = element.offsetHeight;

                if (newLeft >= 0 && newLeft <= screenWidth - winWidth) {
                    element.style.left = newLeft + "px";
                }
                if (newTop >= 0 && newTop <= screenHeight - winHeight) {
                    element.style.top = newTop + "px";
                }
            }

            function dragEnd() {
                element.style.zIndex = 1000;
                document.onmousemove = null;
                document.onmouseup = null;
            }
        }

        // 自动移动和碰撞检测
        function startAutoMove(element) {
            if (element.classList.contains('fixed-tip-window')) return;
            
            function move() {
                const screenWidth = window.innerWidth;
                const screenHeight = window.innerHeight;
                const winWidth = element.offsetWidth;
                const winHeight = element.offsetHeight;

                let x = parseInt(element.style.left) || 0;
                let y = parseInt(element.style.top) || 0;
                let speedX = parseFloat(element.dataset.speedX);
                let speedY = parseFloat(element.dataset.speedY);

                if (x <= 0 || x >= screenWidth - winWidth) {
                    speedX = -speedX;
                    element.dataset.speedX = speedX;
                }
                if (y <= 0 || y >= screenHeight - winHeight) {
                    speedY = -speedY;
                    element.dataset.speedY = speedY;
                }

                x += speedX;
                y += speedY;

                element.style.left = x + 'px';
                element.style.top = y + 'px';

                if (element.parentNode) {
                    requestAnimationFrame(move);
                }
            }

            move();
        }

        // 避免重叠
        function avoidOverlap(newWindow) {
            if (newWindow.classList.contains('fixed-tip-window')) return;
            
            const allWindows = document.querySelectorAll('.warm-tip-window:not(.fixed-tip-window)');
            if (allWindows.length <= 1) return;

            const newRect = newWindow.getBoundingClientRect();
            let overlap = false;

            allWindows.forEach(window => {
                if (window === newWindow) return;
                const rect = window.getBoundingClientRect();
                if (
                    newRect.left < rect.right &&
                    newRect.right > rect.left &&
                    newRect.top < rect.bottom &&
                    newRect.bottom > rect.top
                ) {
                    overlap = true;
                }
            });

            if (overlap) {
                const screenWidth = window.innerWidth;
                const screenHeight = window.innerHeight;
                const winWidth = newWindow.offsetWidth;
                const winHeight = newWindow.offsetHeight;

                const newLeft = 20 + Math.random() * (screenWidth - winWidth - 40);
                const newTop = 20 + Math.random() * (screenHeight - winHeight - 40);

                newWindow.style.left = newLeft + 'px';
                newWindow.style.top = newTop + 'px';
            }
        }

        // 粒子效果
        function createParticles(x, y) {
            const particleCount = 15;

            for (let i = 0; i < particleCount; i++) {
                const particle = document.createElement('div');
                particle.className = 'particle';

                const size = 3 + Math.random() * 8;
                const color = particleColors[Math.floor(Math.random() * particleColors.length)];
                const angle = Math.random() * Math.PI * 2;
                const speed = 2 + Math.random() * 5;
                const distance = 5 + Math.random() * 20;

                particle.style.width = size + 'px';
                particle.style.height = size + 'px';
                particle.style.backgroundColor = color;
                particle.style.left = x - size/2 + 'px';
                particle.style.top = y - size/2 + 'px';

                let startTime = Date.now();
                const duration = 800 + Math.random() * 500;

                function updateParticle() {
                    const elapsed = Date.now() - startTime;
                    if (elapsed > duration) {
                        particle.remove();
                        return;
                    }

                    const progress = elapsed / duration;
                    const currentDistance = distance * progress;
                    const newX = x - size/2 + Math.cos(angle) * currentDistance;
                    const newY = y - size/2 + Math.sin(angle) * currentDistance;

                    particle.style.left = newX + 'px';
                    particle.style.top = newY + 'px';
                    particle.style.opacity = 1 - progress;

                    requestAnimationFrame(updateParticle);
                }

                document.body.appendChild(particle);
                requestAnimationFrame(updateParticle);
            }
        }

        // 更新计数
        function updateTipCount() {
            tipCountElement.innerText = tipCount;
        }

        // 创建装饰性光点
        function createDecorativeDots() {
            // 创建100个随机光点
            for (let i = 0; i < 100; i++) {
                const dot = document.createElement('div');
                dot.className = 'decorative-dot';
                
                // 随机位置
                const x = Math.random() * window.innerWidth;
                const y = Math.random() * window.innerHeight;
                
                // 随机大小和动画延迟
                const size = 1 + Math.random() * 3;
                const delay = Math.random() * 4;
                
                dot.style.left = x + 'px';
                dot.style.top = y + 'px';
                dot.style.width = size + 'px';
                dot.style.height = size + 'px';
                dot.style.animationDelay = delay + 's';
                
                confessionContainer.appendChild(dot);
            }
        }

        // 显示表白界面
        function showConfession() {
            // 隐藏控制面板
            document.querySelector('.control-panel').style.display = 'none';
            
            // 显示表白界面
            confessionContainer.style.display = 'flex';
            
            // 创建装饰性光点
            createDecorativeDots();
            
            // 背景渐变动画
            document.body.style.background = '#f093fb';
        }

        // 清空所有气泡（增强版）
        function clearAllBubbles() {
            const allWindows = document.querySelectorAll('.warm-tip-window');
            allWindows.forEach(window => {
                createParticles(
                    parseInt(window.style.left) + window.offsetWidth/2,
                    parseInt(window.style.top) + window.offsetHeight/2
                );
                window.style.opacity = "0";
                window.style.transform = "scale(0.8)";
                setTimeout(() => {
                    if (window.parentNode) {
                        window.parentNode.removeChild(window);
                    }
                }, 300);
            });
            tipCount = 0;
            updateTipCount();
        }

        // 右键菜单事件
        contextMenu.addEventListener('click', function(e) {
            const action = e.target.dataset.action;
            if (!currentWindow) return;

            if (currentWindow.classList.contains('fixed-tip-window') && 
                (action === 'random' || action === 'close')) {
                contextMenu.style.display = 'none';
                currentWindow = null;
                return;
            }

            switch(action) {
                case 'copy':
                    navigator.clipboard.writeText(currentWindow.innerText)
                        .then(() => {
                            const originalText = currentWindow.innerText;
                            currentWindow.innerText = '复制成功！';
                            setTimeout(() => {
                                currentWindow.innerText = originalText;
                            }, 1000);
                        });
                    break;
                case 'top':
                    currentWindow.style.zIndex = 3000;
                    break;
                case 'random':
                    const screenWidth = window.innerWidth;
                    const screenHeight = window.innerHeight;
                    const winWidth = currentWindow.offsetWidth;
                    const winHeight = currentWindow.offsetHeight;

                    const x = 20 + Math.random() * (screenWidth - winWidth - 40);
                    const y = 20 + Math.random() * (screenHeight - winHeight - 40);

                    currentWindow.style.left = x + 'px';
                    currentWindow.style.top = y + 'px';
                    break;
                case 'close':
                    createParticles(
                        parseInt(currentWindow.style.left) + currentWindow.offsetWidth/2,
                        parseInt(currentWindow.style.top) + currentWindow.offsetHeight/2
                    );
                    currentWindow.style.opacity = "0";
                    currentWindow.style.transform = "scale(0.8)";
                    setTimeout(() => {
                        if (currentWindow.parentNode) {
                            currentWindow.parentNode.removeChild(currentWindow);
                            tipCount--;
                            updateTipCount();
                        }
                    }, 300);
                    break;
            }

            contextMenu.style.display = 'none';
            currentWindow = null;
        });

        // 点击空白处关闭右键菜单
        document.addEventListener('click', function() {
            contextMenu.style.display = 'none';
            currentWindow = null;
        });

        // 点击空白处添加新窗口（仅在解锁后生效）
        document.body.onclick = function(e) {
            if (e.target === document.body) {
                showWarmTip();
                // 只有解锁后才计数
                if (confessionUnlocked) {
                    clickCount++;
                    checkClickCount();
                }
            }
        };

        // 检查点击次数（核心逻辑）
        function checkClickCount() {
            // 只有解锁后且计数满100才显示表白界面
            if (confessionUnlocked && clickCount >= 100) {
                // 清空所有气泡
                clearAllBubbles();
                
                // 延迟显示表白界面（动画过渡）
                setTimeout(() => {
                    showConfession();
                }, 500);
            }
        }

        // 按钮事件
        document.getElementById('addBtn').addEventListener('click', function(e) {
            e.stopPropagation();
            // 无论是否清空都可以新增
            showWarmTip();
            // 只有解锁后才计数
            if (confessionUnlocked) {
                clickCount++;
                checkClickCount();
            }
        });

        document.getElementById('clearBtn').addEventListener('click', function(e) {
            e.stopPropagation();
            if (!hasClearedFirst) {
                // 首次清空 - 解锁表白界面
                clearAllBubbles();
                hasClearedFirst = true;
                confessionUnlocked = true; // 解锁表白界面
                clickCount = 0; // 重置点击计数
            } else {
                // 普通清空
                clearAllBubbles();
            }
        });

        // 窗口大小改变时调整位置
        window.onresize = function() {
            const allWindows = document.querySelectorAll('.warm-tip-window:not(.fixed-tip-window)');
            allWindows.forEach(window => {
                const rect = window.getBoundingClientRect();
                const screenWidth = window.innerWidth;
                const screenHeight = window.innerHeight;
                const winWidth = window.offsetWidth;
                const winHeight = window.offsetHeight;

                let newLeft = rect.left;
                let newTop = rect.top;

                if (newLeft < 0) newLeft = 20;
                if (newLeft > screenWidth - winWidth) newLeft = screenWidth - winWidth - 20;
                if (newTop < 0) newTop = 20;
                if (newTop > screenHeight - winHeight) newTop = screenHeight - winHeight - 20;

                window.style.left = newLeft + 'px';
                window.style.top = newTop + 'px';
            });

            if (fixedTipWindow) {
                const screenWidth = window.innerWidth;
                const screenHeight = window.innerHeight;
                const winWidth = fixedTipWindow.offsetWidth;
                const winHeight = fixedTipWindow.offsetHeight;

                const x = screenWidth - winWidth - 20;
                const y = screenHeight - winHeight - 20;

                fixedTipWindow.style.left = x + 'px';
                fixedTipWindow.style.top = y + 'px';
            }
        };

        // 初始化
        createFixedTipWindow();

        const totalWindows = 30;
        const intervalDelay = 150;

        for (let i = 0; i < totalWindows; i++) {
            setTimeout(() => {
                showWarmTip();
            }, i * intervalDelay);
        }
    </script>
</body>
</html>